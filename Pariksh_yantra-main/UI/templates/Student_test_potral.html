<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Test Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e9f3ff;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #003366;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }

        .container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .left,
        .right {
            width: 48%;
            padding: 20px;
        }

        .left {
            border-right: 1px solid #ccc;
        }

        .questions-list {
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 5px;
            background-color: #f0f8ff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .questions-list li {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            background-color: #e0f7fa;
            transition: background-color 0.2s;
        }

        .questions-list li:hover {
            background-color: #b2ebf2;
        }

        #writingPadContainer {
            border: 2px solid #0056b3;
            width: 100%;
            height: 400px;
            overflow: scroll;
            background-color: #f9f9f9;
            position: relative;
            border-radius: 5px;
        }

        #writingPad {
            background-color: #fff;
        }

        button,
        select {
            margin: 10px;
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-size: 1rem;
        }

        button:hover,
        select:hover {
            background-color: #0056b3;
        }

        label {
            margin-right: 10px;
        }

        .test-details {
            padding: 15px;
            background-color: #e1f5fe;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-details p {
            margin: 5px 0;
            font-size: 1.1rem;
        }

        .canvas-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .canvas-controls > * {
            flex: 1 1 auto;
            margin: 5px;
        }

        .question {
            display: none;
        }

        .question.active {
            display: block;
        }
    </style>
</head>

<body>
    <h1>Test Details</h1>

    <div class="test-details">
        <p><strong>Exam Name:</strong> {{ test_details['name'] }}</p>
        <p><strong>Time:</strong> {{ test_details['time'] }}</p>
        <p><strong>Date:</strong> {{ test_details['date'] }}</p>
        <p><strong>Duration:</strong> {{ test_details['duration'] }}</p>
        <p><strong>Subject:</strong> {{ test_details['subject'] }}</p>
        <p><strong>Faculty:</strong> {{ test_details['faculty '] }}</p>
        <p><strong>Total Marks:</strong> {{ test_details['total  marks'] }}</p>
    </div>

    <div class="container">
        <div class="left">
            <h2>Questions</h2>
            <div class="questions-list">
                {% for question in questions %}
                <div class="question{% if loop.index == 1 %} active{% endif %}" id="question{{ loop.index }}">
                    <p>{{ question['Question'] }} - Marks: {{ question['Marks'] }}</p>
                </div>
                {% endfor %}
            </div>
            <div class="navigation-controls">
                <button onclick="prevQuestion()">Previous</button>
                <button onclick="nextQuestion()">Next</button>
            </div>
        </div>

        <div class="right">
            <h3>Write Your Answer Here:</h3>
            <div id="writingPadContainer">
                <canvas id="writingPad" width="800" height="1200"></canvas>
            </div>
            <br>
            <div class="canvas-controls">
                <button onclick="clearCanvas()">Clear</button>
                <button onclick="saveCanvas()">Save Answer</button>
                <button onclick="saveAsPDF()">Save as PDF</button>
                <button onclick="undo()">Undo</button>
                <button onclick="redo()">Redo</button>
                <button onclick="setEraser()">Eraser</button>
                <button onclick="setPen()">Pen</button>
                <label for="penSize">Pen Size:</label>
                <select id="penSize" onchange="changePenSize(this.value)">
                    <option value="1">Extra Small</option>
                    <option value="2">Small</option>
                    <option value="3">Medium</option>
                    <option value="4">Large</option>
                </select>
                <input type="color" id="penColor" value="#000000" onchange="changePenColor(this.value)">
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const canvas = document.getElementById('writingPad');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let lastX = 0, lastY = 0;
        let isErasing = false;
        let history = [];
        let historyStep = -1;

        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#000000';

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawingTouch, { passive: false });
        canvas.addEventListener('touchmove', drawTouch, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            drawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
            saveState();
        }

        function draw(e) {
            if (!drawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function stopDrawing() {
            drawing = false;
            ctx.beginPath();
        }

        function startDrawingTouch(e) {
            e.preventDefault();
            drawing = true;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
            saveState();
        }

        function drawTouch(e) {
            e.preventDefault();
            if (!drawing) return;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            ctx.stroke();
            [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            history = [];
            historyStep = -1;
        }

        function saveCanvas() {
            const answer = canvas.toDataURL();
            console.log(answer); // Here you can send the answer to the server
            alert('Answer saved!');
        }

        function saveAsPDF() {
            const pdf = new jsPDF();
            const imgData = canvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 10, 10);
            pdf.save('answer.pdf');
        }

        function undo() {
            if (historyStep <= 0) return;
            historyStep--;
            const img = new Image();
            img.src = history[historyStep];
            img.onload = () => {
                clearCanvas();
                ctx.drawImage(img, 0, 0);
            };
        }

        function redo() {
            if (historyStep >= history.length - 1) return;
            historyStep++;
            const img = new Image();
            img.src = history[historyStep];
            img.onload = () => {
                clearCanvas();
                ctx.drawImage(img, 0, 0);
            };
        }

        function saveState() {
            if (historyStep < history.length - 1) {
                history = history.slice(0, historyStep + 1);
            }
            history.push(canvas.toDataURL());
            historyStep++;
        }

        function setEraser() {
            isErasing = true;
            ctx.strokeStyle = '#ffffff'; // Match the canvas background color
        }

        function setPen() {
            isErasing = false;
            ctx.strokeStyle = document.getElementById('penColor').value;
        }

        function changePenSize(size) {
            ctx.lineWidth = size;
        }

        function changePenColor(color) {
            ctx.strokeStyle = color;
        }

        let currentQuestionIndex = 0;
        const questions = document.querySelectorAll('.question');

        function showQuestion(index) {
            questions.forEach((question, i) => {
                question.classList.toggle('active', i === index);
            });
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            }
        }

        // Show the first question on page load
        showQuestion(currentQuestionIndex);
    </script>
    <form action="{{ url_for('submit') }}" method="POST">
        <button type="submit">Submit</button>
    </form>
</body>

</html>
